name: Deploy to GitHub Pages

on:
  push:
    branches: 
      - main
      - combat
      - develop  # Add other branches you want to deploy
      # - feature/*  # Uncomment to deploy all feature branches
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all branches
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - run: npm ci
      
      - name: Determine base path
        id: base-path
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT
          
          if [ "$BRANCH_NAME" = "main" ]; then
            echo "base=/${{ github.event.repository.name }}/" >> $GITHUB_OUTPUT
            echo "target=main" >> $GITHUB_OUTPUT
          else
            echo "base=/${{ github.event.repository.name }}/$BRANCH_NAME/" >> $GITHUB_OUTPUT
            echo "target=$BRANCH_NAME" >> $GITHUB_OUTPUT
          fi
      
      - name: Build
        env:
          BASE_URL: ${{ steps.base-path.outputs.base }}
        run: npx vite build
      
      - name: Prepare deployment directory
        run: |
          mkdir -p deploy
          
          # Try to fetch existing gh-pages branch and extract to temp directory
          echo "Attempting to preserve existing deployments..."
          if git ls-remote --exit-code origin gh-pages; then
            echo "Found existing gh-pages branch, preserving content..."
            
            # Create a worktree for gh-pages in a temp directory
            git worktree add gh-pages-temp gh-pages 2>/dev/null || git worktree add gh-pages-temp origin/gh-pages
            
            # Copy all existing content from gh-pages to deploy
            cp -r gh-pages-temp/* deploy/ 2>/dev/null || true
            cp -r gh-pages-temp/.[!.]* deploy/ 2>/dev/null || true
            
            # Clean up worktree
            git worktree remove gh-pages-temp --force
            
            # Remove git files from deploy
            rm -rf deploy/.git deploy/.github
          else
            echo "No existing gh-pages branch found"
          fi
          
          # Now overlay the new build (this will overwrite files)
          if [ "${{ steps.base-path.outputs.target }}" = "main" ]; then
            # For main branch, copy to root (overwriting existing root files)
            cp -r dist/* deploy/
          else
            # For other branches, create/update subfolder
            mkdir -p deploy/${{ steps.base-path.outputs.target }}
            cp -r dist/* deploy/${{ steps.base-path.outputs.target }}/
          fi
      
      - name: Check deployment structure
        run: |
          echo "Deployment directory structure:"
          ls -la deploy/
          echo "---"
          find deploy -type f | head -20
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './deploy'
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
